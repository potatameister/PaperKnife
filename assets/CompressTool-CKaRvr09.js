import{b as q,t as z,j as t,Z as P,d as G,D as H,f as K}from"./index-FnbFU1p3.js";import{r as d,J as V}from"./utilities-8Xav_QdM.js";import{P as X}from"./pdf-core-B42Ge-vd.js";import{g as W,u as Y,l as _}from"./pdfHelpers-quNdLaSm.js";import{T as ee,L as te,P as se}from"./PrivacyBadge-DV5EnHSi.js";import{S as ae}from"./SuccessState-BQEu-omc.js";import{F as re}from"./file-7FIF9nps.js";import{X as ie}from"./x-Bfg-ZPj0.js";import"./pdf-viewer-DFtpL4X_.js";function be(){const x=d.useRef(null),{consumePipelineFile:R,setPipelineFile:M}=q(),[n,l]=d.useState([]),[b,C]=d.useState(!1),[S,D]=d.useState(0),[w,A]=d.useState("medium"),[u,y]=d.useState(null),[E,h]=d.useState(!1);d.useEffect(()=>{const e=R();if(e)try{const r=new Blob([e.buffer],{type:"application/pdf"}),s=new File([r],e.name,{type:"application/pdf"});k([s]),z.info(`Received ${s.name} from pipeline`)}catch(r){console.error("Pipeline file conversion failed",r);const s=new Blob([e.buffer],{type:"application/pdf"}),a=new File([s],e.name,{type:"application/pdf"});k([a])}},[]);const k=async e=>{const r=Array.from(e).filter(s=>s.type==="application/pdf").map(s=>({id:Math.random().toString(36).substr(2,9),file:s,pageCount:0,isLocked:!1,status:"pending"}));l(s=>[...s,...r]),h(!1),y(null);for(const s of r)try{const a=await W(s.file);l(o=>o.map(i=>i.id===s.id?{...i,pageCount:a.pageCount,isLocked:a.isLocked,thumbnail:a.thumbnail,pdfDoc:a.isLocked?void 0:null}:i))}catch(a){console.error(a)}},$=async(e,r)=>{const s=n.find(o=>o.id===e);if(!s)return;const a=await Y(s.file,r);a.success?l(o=>o.map(i=>i.id===e?{...i,isLocked:!1,pageCount:a.pageCount,pdfDoc:a.pdfDoc,thumbnail:a.thumbnail,password:r}:i)):z.error(`Incorrect password for ${s.file.name}`)},I=e=>{e.target.files&&k(e.target.files)},O=async(e,r)=>{let s=e.pdfDoc;s||(s=await _(e.file));const a=await X.create(),o={high:1,medium:1.5,low:2},i={high:.3,medium:.5,low:.7},c=o[r],j=i[r];for(let v=1;v<=e.pageCount;v++){const L=await s.getPage(v),p=L.getViewport({scale:c}),g=document.createElement("canvas"),U=g.getContext("2d");if(!U)continue;g.height=p.height,g.width=p.width,await L.render({canvasContext:U,viewport:p}).promise;const J=g.toDataURL("image/jpeg",j).split(",")[1],N=window.atob(J),B=new Uint8Array(N.length);for(let f=0;f<N.length;f++)B[f]=N.charCodeAt(f);const Q=await a.embedJpg(B);a.addPage([p.width,p.height]).drawImage(Q,{x:0,y:0,width:p.width,height:p.height})}const m=await a.save(),F=new Blob([m],{type:"application/pdf"});return{url:URL.createObjectURL(F),size:F.size,buffer:m}},Z=async()=>{const e=n.filter(s=>!s.isLocked&&s.status==="pending");if(e.length===0)return;C(!0),D(0);const r=[];for(let s=0;s<e.length;s++){const a=e[s];l(o=>o.map(i=>i.id===a.id?{...i,status:"processing"}:i));try{const{url:o,size:i,buffer:c}=await O(a,w);r.push({name:a.file.name.replace(".pdf","-compressed.pdf"),buffer:c}),l(j=>j.map(m=>m.id===a.id?{...m,status:"completed",resultUrl:o,resultSize:i}:m)),K({name:a.file.name.replace(".pdf","-compressed.pdf"),tool:"Compress",size:i,resultUrl:o}),e.length===1&&M({buffer:c,name:a.file.name.replace(".pdf","-compressed.pdf")})}catch{l(i=>i.map(c=>c.id===a.id?{...c,status:"error"}:c)),z.error(`Failed to compress ${a.file.name}`)}D(Math.round((s+1)/e.length*100))}if(r.length>1){const s=new V;r.forEach(o=>s.file(o.name,o.buffer));const a=await s.generateAsync({type:"blob"});y(URL.createObjectURL(a))}C(!1),h(!0)},T=e=>{l(r=>r.filter(s=>s.id!==e)),n.length<=1&&h(!1)};return t.jsx("div",{className:"flex-1",children:t.jsxs("main",{className:"max-w-4xl mx-auto px-6 py-6 md:py-10",children:[t.jsx(ee,{title:"Batch",highlight:"Shrinker",description:"Optimize multiple PDFs at once. Everything stays on your device."}),t.jsx("input",{type:"file",multiple:!0,accept:".pdf",className:"hidden",ref:x,onChange:I}),n.length===0?t.jsxs("div",{onClick:()=>{var e;return(e=x.current)==null?void 0:e.click()},className:"border-4 border-dashed border-gray-200 dark:border-zinc-800 rounded-[2rem] md:rounded-[2.5rem] bg-white/50 dark:bg-zinc-900/50 p-10 md:p-20 text-center hover:border-rose-300 dark:hover:border-rose-900 hover:bg-rose-50/50 dark:hover:bg-rose-900/10 transition-all cursor-pointer group",children:[t.jsx("div",{className:"w-16 h-16 md:w-24 md:h-24 bg-rose-100 dark:bg-rose-900/30 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 md:mb-6 group-hover:scale-110 transition-transform",children:t.jsx(P,{size:32})}),t.jsx("h3",{className:"text-xl md:text-2xl font-bold mb-1 md:mb-2 group-hover:text-rose-600 dark:group-hover:text-rose-400 transition-colors",children:"Select PDFs"}),t.jsx("p",{className:"text-xs md:text-sm text-gray-400 dark:text-zinc-500",children:"Drop files or tap to start batch compression"})]}):E?t.jsxs("div",{className:"space-y-6",children:[u&&t.jsxs("a",{href:u,download:"paperknife-compressed-batch.zip",className:"block w-full bg-zinc-900 dark:bg-white text-white dark:text-black p-8 rounded-[2.5rem] text-center shadow-2xl transition-all hover:scale-[1.01] active:scale-95 group",children:[t.jsx("div",{className:"w-16 h-16 bg-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform",children:t.jsx(H,{className:"text-white",size:32})}),t.jsx("h3",{className:"text-2xl font-black tracking-tight mb-1",children:"Download All (ZIP)"}),t.jsxs("p",{className:"text-xs font-bold opacity-60 uppercase tracking-widest",children:[n.length," Optimized Documents"]})]}),!u&&n.length===1&&t.jsx(ae,{message:"Success! File compressed.",downloadUrl:n[0].resultUrl,fileName:n[0].file.name.replace(".pdf","-compressed.pdf"),onStartOver:()=>{l([]),h(!1)}}),u&&t.jsx("button",{onClick:()=>{l([]),h(!1),y(null)},className:"w-full py-4 text-gray-400 hover:text-rose-500 font-black uppercase tracking-[0.2em] text-xs transition-colors",children:"Start New Batch"})]}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n.map(e=>t.jsxs("div",{className:"bg-white dark:bg-zinc-900 p-4 rounded-2xl border border-gray-100 dark:border-zinc-800 flex items-center gap-4 relative group",children:[t.jsx("div",{className:"w-12 h-16 bg-gray-50 dark:bg-zinc-800 rounded-lg overflow-hidden shrink-0",children:e.thumbnail?t.jsx("img",{src:e.thumbnail,className:"w-full h-full object-cover"}):t.jsx("div",{className:"w-full h-full flex items-center justify-center",children:t.jsx(re,{className:"text-gray-300",size:16})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-xs font-bold truncate dark:text-white",children:e.file.name}),e.isLocked?t.jsx("div",{className:"flex gap-1 mt-1",children:t.jsx("input",{type:"password",placeholder:"Unlock...",className:"bg-gray-50 dark:bg-black text-[8px] p-1 rounded border border-gray-100 dark:border-zinc-800 outline-none w-20",onKeyDown:r=>{r.key==="Enter"&&$(e.id,r.currentTarget.value)}})}):t.jsxs("p",{className:"text-[10px] text-gray-400 font-bold",children:[(e.file.size/(1024*1024)).toFixed(2)," MB â€¢ ",e.pageCount," p"]})]}),t.jsx("button",{onClick:()=>T(e.id),className:"p-1 text-gray-300 hover:text-rose-500",children:t.jsx(ie,{size:14})})]},e.id)),t.jsxs("button",{onClick:()=>{var e;return(e=x.current)==null?void 0:e.click()},className:"border-2 border-dashed border-gray-100 dark:border-zinc-800 rounded-2xl p-4 text-gray-400 flex flex-col items-center justify-center gap-1 hover:border-rose-300 transition-all",children:[t.jsx(G,{size:20}),t.jsx("span",{className:"text-[10px] font-black uppercase tracking-tighter",children:"Add More"})]})]}),t.jsxs("div",{className:"bg-white dark:bg-zinc-900 p-8 rounded-[2rem] border border-gray-100 dark:border-zinc-800 shadow-sm space-y-8",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-4 flex items-center gap-2",children:[t.jsx(P,{size:12})," Compression Quality"]}),t.jsx("div",{className:"grid grid-cols-3 gap-3",children:["high","medium","low"].map(e=>t.jsxs("button",{onClick:()=>A(e),className:`p-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-1 ${w===e?"border-rose-500 bg-rose-50/50 dark:bg-rose-900/10":"border-gray-100 dark:border-zinc-800 hover:border-rose-200 dark:hover:border-rose-800"}`,children:[t.jsx("span",{className:`font-black uppercase text-[10px] ${w===e?"text-rose-500":"text-gray-400"}`,children:e}),t.jsx("span",{className:"text-[8px] text-gray-400 font-bold",children:e==="high"?"Max":e==="medium"?"Balanced":"Best"})]},e))})]}),b&&t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"w-full bg-gray-100 dark:bg-zinc-800 h-2 rounded-full overflow-hidden",children:t.jsx("div",{className:"bg-rose-500 h-full transition-all duration-300",style:{width:`${S}%`}})}),t.jsxs("p",{className:"text-[10px] text-center font-black uppercase text-gray-400 tracking-widest animate-pulse",children:["Batch Progress: ",S,"%"]})]}),t.jsxs("button",{onClick:Z,disabled:b||n.filter(e=>!e.isLocked).length===0,className:"w-full bg-rose-500 hover:bg-rose-600 text-white p-6 rounded-3xl shadow-xl shadow-rose-200 dark:shadow-none font-black text-xl tracking-tight transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-3",children:[b?t.jsx(te,{className:"animate-spin"}):t.jsx(P,{}),"Compress ",n.length," Files"]})]})]}),t.jsx(se,{})]})})}export{be as default};
